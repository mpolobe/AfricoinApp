version: 0.2

env:
  variables:
    # S3 Configuration
    S3_BUCKET: "africoin-static-website2"
    AWS_REGION: "eu-north-1"
    S3_ARTIFACTS_BUCKET: "africoin-static-website2"
    
    # CloudFront Configuration
    CLOUDFRONT_DISTRIBUTION_ID: "E2KMX26L7TC7HC"
    CLOUDFRONT_DOMAIN: "d36ca0du81ok0y.cloudfront.net"
    
    # Amplify Configuration (for reference)
    AMPLIFY_APP_ID: "d11y4132uklopb"
    
    # Build Configuration
    NODE_ENV: "production"
    NODE_OPTIONS: "--max-old-space-size=4096"

cache:
  paths:
    - 'node_modules/**/*'
    - '/root/.npm/**/*'

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              ğŸš€ AFRICOIN PRODUCTION DEPLOYMENT               â•‘"
        echo "â•‘         S3 + CloudFront Automated Deployment Pipeline        â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“… Build started: $(date)"
        echo "ğŸŒ AWS Region: $AWS_REGION"
        echo "ğŸ“¦ S3 Bucket: $S3_BUCKET"
        echo "â˜ï¸  CloudFront Distribution: $CLOUDFRONT_DISTRIBUTION_ID"
        echo "ğŸŒ CloudFront Domain: $CLOUDFRONT_DOMAIN"
        echo "âš¡ Amplify App ID: $AMPLIFY_APP_ID"
        echo ""
        echo "ğŸ“‹ Environment:"
        echo "   - Node.js: $(node --version)"
        echo "   - npm: $(npm --version)"
        echo "   - AWS CLI: $(aws --version 2>&1 | head -1)"

  pre_build:
    commands:
      - |
        echo ""
        echo "ğŸ” VALIDATING PROJECT STRUCTURE"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Check if project directory exists
        if [ -d "scroll-waitlist-exchange-1" ]; then
          cd scroll-waitlist-exchange-1
          echo "âœ… Found project directory: scroll-waitlist-exchange-1/"
        else
          echo "âŒ ERROR: Project directory not found!"
          echo "Current directory structure:"
          ls -la
          exit 1
        fi
        
        echo "ğŸ“ Working directory: $(pwd)"
        echo "ğŸ“„ Package.json exists: $(test -f package.json && echo 'âœ… Yes' || echo 'âŒ No')"
        echo "âš™ï¸  Vite config exists: $(test -f vite.config.ts && echo 'âœ… Yes' || echo 'âŒ No')"
        
        # Check Vite configuration for relative paths
        if [ -f "vite.config.ts" ]; then
          if grep -q "base: './'" vite.config.ts; then
            echo "âœ… Vite configured with base: './' (relative paths for S3)"
          else
            echo "âš ï¸  WARNING: vite.config.ts may not have base: './'"
            echo "   This could cause asset loading issues on S3"
          fi
        fi

  build:
    commands:
      - |
        echo ""
        echo "ğŸ”§ BUILDING REACT APPLICATION"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        echo "ğŸ“¦ Step 1: Installing dependencies..."
        echo "   Node options: $NODE_OPTIONS"
        echo "   Environment: $NODE_ENV"
        
        # Clean install for consistency
        rm -rf node_modules package-lock.json
        npm install --legacy-peer-deps --loglevel=error
        
        if [ $? -ne 0 ]; then
          echo "âŒ ERROR: npm install failed"
          exit 1
        fi
        
        echo "âœ… Dependencies installed successfully"
        
        echo ""
        echo "ğŸ—ï¸  Step 2: Building production bundle..."
        export NODE_OPTIONS="$NODE_OPTIONS"
        npm run build
        
        if [ $? -ne 0 ]; then
          echo "âŒ ERROR: Build failed"
          exit 1
        fi
        
        echo ""
        echo "ğŸ” BUILD OUTPUT ANALYSIS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Verify build output
        if [ ! -d "dist" ]; then
          echo "âŒ CRITICAL ERROR: dist directory not created!"
          exit 1
        fi
        
        echo "âœ… Build directory created: dist/"
        echo ""
        echo "ğŸ“ Directory structure:"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        ls -lah dist/
        
        echo ""
        if [ -d "dist/assets" ]; then
          echo "ğŸ“¦ Assets directory contents:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ls -lah dist/assets/ | head -10
          echo ""
          
          # Count files
          JS_COUNT=$(find dist/assets -name "*.js" -type f | wc -l)
          CSS_COUNT=$(find dist/assets -name "*.css" -type f | wc -l)
          echo "   JavaScript files: $JS_COUNT"
          echo "   CSS files: $CSS_COUNT"
        fi
        
        echo ""
        if [ -f "dist/index.html" ]; then
          echo "ğŸ“„ index.html verification:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ… File exists (Size: $(stat -c%s dist/index.html) bytes)"
          
          # Check for relative paths
          echo ""
          echo "ğŸ”— Asset path analysis:"
          if grep -q 'src="\./' dist/index.html && grep -q 'href="\./' dist/index.html; then
            echo "âœ… All assets use relative paths (./)"
          else
            echo "âš ï¸  WARNING: Some assets may not have relative paths"
            echo "   First few asset references:"
            grep -E 'src="|href=' dist/index.html | head -5
          fi
          
          # Create case-insensitive copy for S3
          cp dist/index.html dist/Index.html
          echo "âœ… Created Index.html (case-insensitive access)"
          
          # Display first 3 lines for verification
          echo ""
          echo "ğŸ“‹ First 3 lines of index.html:"
          head -3 dist/index.html
        else
          echo "âŒ CRITICAL ERROR: index.html not found in dist/"
          exit 1
        fi
        
        echo ""
        echo "âœ… BUILD PHASE COMPLETED SUCCESSFULLY"

  post_build:
    commands:
      - |
        echo ""
        echo "ğŸš€ DEPLOYMENT PHASE: S3 + CLOUDFRONT"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        
        # Set deployment variables
        REGION="${AWS_REGION:-eu-north-1}"
        S3_URL="http://$S3_BUCKET.s3-website.$REGION.amazonaws.com"
        CF_DOMAIN="$CLOUDFRONT_DOMAIN"
        CF_ID="$CLOUDFRONT_DISTRIBUTION_ID"
        
        echo "ğŸ“Š Deployment Configuration:"
        echo "   - S3 Bucket: $S3_BUCKET"
        echo "   - Region: $REGION"
        echo "   - CloudFront ID: $CF_ID"
        echo "   - CloudFront Domain: $CF_DOMAIN"
        echo ""
        
        ####################################################################
        # STEP 1: CONFIGURE S3 BUCKET
        ####################################################################
        echo "ğŸ”§ STEP 1: Configuring S3 Bucket"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # Configure S3 for static website hosting
        echo "   Configuring static website hosting..."
        aws s3api put-bucket-website \
          --bucket "$S3_BUCKET" \
          --website-configuration '{
            "IndexDocument": {"Suffix": "index.html"},
            "ErrorDocument": {"Key": "index.html"}
          }' \
          --region "$REGION" 2>/dev/null || echo "   âœ“ Website configuration already exists"
        
        # Set bucket policy for public read access
        echo "   Setting bucket policy..."
        aws s3api put-bucket-policy \
          --bucket "$S3_BUCKET" \
          --policy "{
            \"Version\": \"2012-10-17\",
            \"Statement\": [
              {
                \"Sid\": \"PublicReadGetObject\",
                \"Effect\": \"Allow\",
                \"Principal\": \"*\",
                \"Action\": \"s3:GetObject\",
                \"Resource\": \"arn:aws:s3:::$S3_BUCKET/*\"
              }
            ]
          }" \
          --region "$REGION" 2>/dev/null || echo "   âœ“ Bucket policy already exists"
        
        # Remove public access blocks
        echo "   Removing public access blocks..."
        aws s3api delete-public-access-block \
          --bucket "$S3_BUCKET" \
          --region "$REGION" 2>/dev/null || echo "   âœ“ Public access blocks already removed"
        
        # Configure CORS
        echo "   Configuring CORS..."
        aws s3api put-bucket-cors \
          --bucket "$S3_BUCKET" \
          --cors-configuration '{
            "CORSRules": [
              {
                "AllowedOrigins": ["*"],
                "AllowedMethods": ["GET", "HEAD"],
                "AllowedHeaders": ["*"],
                "MaxAgeSeconds": 3000
              }
            ]
          }' \
          --region "$REGION" 2>/dev/null || echo "   âœ“ CORS already configured"
        
        echo "   âœ… S3 bucket configuration complete"
        
        ####################################################################
        # STEP 2: UPLOAD FILES TO S3
        ####################################################################
        echo ""
        echo "ğŸ“¤ STEP 2: Uploading Files to S3"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # Upload all static assets with long cache TTL
        echo "   Uploading static assets (cache: 1 year)..."
        aws s3 sync dist/ "s3://$S3_BUCKET/" \
          --region "$REGION" \
          --delete \
          --cache-control "max-age=31536000, public, immutable" \
          --exclude "index.html" \
          --exclude "Index.html" \
          --exclude "*.html"
        
        # Upload HTML files with no-cache headers
        echo "   Uploading HTML files (no-cache)..."
        aws s3 cp dist/index.html "s3://$S3_BUCKET/index.html" \
          --region "$REGION" \
          --content-type "text/html; charset=utf-8" \
          --cache-control "no-cache, no-store, must-revalidate"
        
        aws s3 cp dist/Index.html "s3://$S3_BUCKET/Index.html" \
          --region "$REGION" \
          --content-type "text/html; charset=utf-8" \
          --cache-control "no-cache, no-store, must-revalidate"
        
        # Upload any remaining HTML files
        echo "   Uploading other HTML files..."
        find dist/ -name "*.html" ! -name "index.html" ! -name "Index.html" -exec \
          aws s3 cp {} "s3://$S3_BUCKET/$(basename {})" \
            --region "$REGION" \
            --content-type "text/html; charset=utf-8" \
            --cache-control "no-cache, no-store, must-revalidate" \;
        
        echo "   âœ… S3 upload complete"
        echo "   ğŸ“ Total files uploaded: $(find dist/ -type f | wc -l)"
        
        ####################################################################
        # STEP 3: CLOUDFRONT CACHE INVALIDATION
        ####################################################################
        echo ""
        echo "â˜ï¸  STEP 3: CloudFront Cache Management"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        if [ -n "$CF_ID" ] && [ "$CF_ID" != "none" ]; then
          echo "   Creating CloudFront cache invalidation..."
          INVALIDATION_RESPONSE=$(aws cloudfront create-invalidation \
            --distribution-id "$CF_ID" \
            --paths "/*" \
            --region "$REGION" 2>&1)
          
          if echo "$INVALIDATION_RESPONSE" | grep -q "Invalidation"; then
            INVALIDATION_ID=$(echo "$INVALIDATION_RESPONSE" | grep -o '"Id": "[^"]*"' | cut -d'"' -f4)
            echo "   âœ… Invalidation created: $INVALIDATION_ID"
            echo "   â³ Cache refresh will complete within 1-2 minutes"
          else
            echo "   âš ï¸  WARNING: Could not create invalidation"
            echo "      Response: $INVALIDATION_RESPONSE"
            echo "      (This may be a permissions issue or distribution doesn't exist)"
          fi
        else
          echo "   âš ï¸  SKIPPING: CLOUDFRONT_DISTRIBUTION_ID not set"
          echo "      Set environment variable to enable CloudFront cache invalidation"
        fi
        
        ####################################################################
        # STEP 4: VERIFICATION & TESTING
        ####################################################################
        echo ""
        echo "ğŸ§ª STEP 4: Deployment Verification"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # Wait for S3 propagation
        echo "   Waiting for S3 propagation..."
        sleep 5
        
        # Test S3 deployment
        echo "   Testing S3 deployment..."
        S3_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$S3_URL/" 2>/dev/null || echo "TIMEOUT")
        S3_DASHBOARD_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$S3_URL/dashboard" 2>/dev/null || echo "TIMEOUT")
        
        echo "     S3 Homepage (/): HTTP $S3_STATUS"
        echo "     S3 Dashboard (/dashboard): HTTP $S3_DASHBOARD_STATUS"
        
        if [ "$S3_STATUS" = "200" ]; then
          echo "     âœ… S3 deployment successful"
        else
          echo "     âš ï¸  S3 deployment issue (may be propagating)"
        fi
        
        # Test CloudFront deployment (if configured)
        if [ -n "$CF_DOMAIN" ] && [ "$CF_DOMAIN" != "none" ]; then
          echo ""
          echo "   Testing CloudFront deployment..."
          CF_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$CF_DOMAIN/" 2>/dev/null || echo "TIMEOUT")
          CF_DASHBOARD_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$CF_DOMAIN/dashboard" 2>/dev/null || echo "TIMEOUT")
          
          echo "     CloudFront Homepage (/): HTTP $CF_STATUS"
          echo "     CloudFront Dashboard (/dashboard): HTTP $CF_DASHBOARD_STATUS"
          
          if [ "$CF_STATUS" = "200" ] && [ "$CF_DASHBOARD_STATUS" = "200" ]; then
            echo "     âœ… CloudFront SPA routing is working!"
          elif [ "$CF_STATUS" = "000" ] || [ "$CF_STATUS" = "503" ]; then
            echo "     â³ CloudFront still deploying... (normal for first 5-15 minutes)"
          else
            echo "     âš ï¸  CloudFront status check failed"
          fi
        fi
        
        ####################################################################
        # STEP 5: DEPLOYMENT SUMMARY
        ####################################################################
        echo ""
        echo "ğŸ“‹ DEPLOYMENT SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ‰ DEPLOYMENT COMPLETED: $(date)"
        echo ""
        echo "ğŸ”— ACCESS URLS:"
        echo "   ğŸŒ S3 Website URL: $S3_URL"
        
        if [ -n "$CF_DOMAIN" ] && [ "$CF_DOMAIN" != "none" ]; then
          echo "   â˜ï¸  CloudFront URL: https://$CF_DOMAIN"
          echo "   ğŸ“± Production URL: https://$CF_DOMAIN (Recommended)"
        else
          echo "   ğŸ“± Production URL: $S3_URL"
        fi
        
        echo ""
        echo "ğŸ“Š DEPLOYMENT STATUS:"
        echo "   âœ… Build: Completed"
        echo "   âœ… S3 Upload: Completed"
        
        if [ -n "$INVALIDATION_ID" ]; then
          echo "   âœ… CloudFront Cache: Invalidated ($INVALIDATION_ID)"
          echo "      Cache will refresh within 1-2 minutes"
        elif [ -n "$CF_ID" ] && [ "$CF_ID" != "none" ]; then
          echo "   âš ï¸  CloudFront Cache: Not invalidated (check permissions)"
        else
          echo "   â„¹ï¸  CloudFront Cache: Not configured"
        fi
        
        echo ""
        echo "ğŸ” TEST ENDPOINTS:"
        echo "   S3 Tests:"
        echo "     curl -I $S3_URL/"
        echo "     curl -I $S3_URL/dashboard"
        
        if [ -n "$CF_DOMAIN" ] && [ "$CF_DOMAIN" != "none" ]; then
          echo ""
          echo "   CloudFront Tests:"
          echo "     curl -I https://$CF_DOMAIN/"
          echo "     curl -I https://$CF_DOMAIN/dashboard"
          echo "     curl -I https://$CF_DOMAIN/user"
          echo "     curl -I https://$CF_DOMAIN/admin"
        fi
        
        echo ""
        echo "ğŸ”§ TROUBLESHOOTING:"
        echo "   1. If assets don't load: Check browser console for 404 errors"
        echo "   2. If SPA routing fails: Verify S3 ErrorDocument is 'index.html'"
        echo "   3. If CloudFront shows old content: Wait 2 minutes for cache"
        echo "   4. For 403 errors: Check S3 bucket policy and public access"
        
        echo ""
        echo "ğŸ”„ NEXT DEPLOYMENT:"
        echo "   Simply commit and push changes to trigger automatic deployment"
        
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸš€ AFRICOIN APPLICATION SUCCESSFULLY DEPLOYED TO PRODUCTION! ğŸš€"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

artifacts:
  files:
    - '**/*'
  base-directory: 'scroll-waitlist-exchange-1'
  discard-paths: no